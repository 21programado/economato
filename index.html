<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Materiales</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  margin:0;
  padding:20px;
}
h1,h2{ margin-top:0 }
.container{
  max-width:1100px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:6px;
}
label{ font-weight:bold }
input,select,textarea,button{
  width:100%;
  padding:8px;
  margin:5px 0 15px 0;
  box-sizing:border-box;
}
button{
  background:#f77f00;
  border:none;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
button.secondary{
  background:#999;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:14px;
}
th{ background:#fcad56 }
.actions button{
  width:auto;
  margin-right:5px;
}
.range{
  display:flex;
  gap:10px;
  align-items:end;
}
.range div{ flex:1 }
small{ color:#555 }
</style>
</head>

<body>
<div class="container">

<h1>Registro de Materiales</h1>

<form id="formRegistro">
  <label>Nombre</label>
  <input required id="nombre">

  <label>Cargo</label>
  <select id="cargo">
    <option>Auxiliar de Enfermería</option>
    <option>Licenciada en Enfermería</option>
    <option>Practicante Interno</option>
    <option>Médico</option>
    <option>ASG</option>
    <option>Otro</option>
  </select>

  <label>Equipo</label>
  <select id="equipo">
    <option>ECG</option>
    <option>Monitor</option>
    <option>Saturómetro</option>
    <option>Valija de traslado</option>
    <option>Otoscopio</option>
    <option>HGT A</option>
    <option>HGT B</option>
    <option>HGT C</option>
    <option>Videolaringoscopio</option>
    <option>Otro</option>
  </select>

  <label>Comentario</label>
  <textarea id="comentario"></textarea>

  <button type="submit">Registrar ENTREGA</button>
</form>

<hr>

<h2>Historial</h2>

<table id="tabla">
<thead>
<tr>
  <th>Fecha</th>
  <th>Hora</th>
  <th>Nombre</th>
  <th>Cargo</th>
  <th>Equipo</th>
  <th>Entrega</th>
  <th>Devolución</th>
  <th>Comentario</th>
  <th>Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>

<hr>

<h2>PDF por rango de fechas</h2>
<div class="range">
  <div>
    <label>Desde</label>
    <input type="date" id="desde">
  </div>
  <div>
    <label>Hasta</label>
    <input type="date" id="hasta">
  </div>
  <div>
    <button onclick="generarPDF()">Generar PDF</button>
  </div>
</div>

<hr>

<h2>Respaldo</h2>
<button onclick="exportar()">Descargar respaldo JSON</button>
<input type="file" onchange="importar(event)">
<small>Importar reemplaza los datos actuales</small>

</div>

<script>
/* ================== CLAVE ================== */
(function(){
  let clave = localStorage.getItem("clave_app");
  if(!clave){
    let nueva = prompt("Crear clave de acceso");
    if(!nueva){ alert("Clave requerida"); location.reload(); }
    localStorage.setItem("clave_app", nueva);
  }else{
    let ingreso = prompt("Ingrese la clave");
    if(ingreso !== clave){
      alert("Clave incorrecta");
      location.reload();
    }
  }
})();

/* ================== DATOS ================== */
let registros = JSON.parse(localStorage.getItem("registros")||"[]");
const tbody = document.querySelector("#tabla tbody");

function guardar(){
  localStorage.setItem("registros", JSON.stringify(registros));
}

function ahora(){
  const d = new Date();
  return {
    fecha: d.toISOString().slice(0,10),
    hora: d.toTimeString().slice(0,5)
  };
}

/* ================== RENDER ================== */
function render(){
  tbody.innerHTML="";
  registros.forEach((r,i)=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.fecha}</td>
      <td>${r.hora}</td>
      <td>${r.nombre}</td>
      <td>${r.cargo}</td>
      <td>${r.equipo}</td>
      <td>${r.entrega}</td>
      <td>${r.devolucion||"Pendiente"}</td>
      <td>${r.comentario||""}</td>
      <td class="actions">
        ${!r.devolucion?`<button onclick="devolver(${i})">Devolver</button>`:""}
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ================== ENTREGA ================== */
document.getElementById("formRegistro").onsubmit=e=>{
  e.preventDefault();
  if(!confirm("¿Confirma entrega?")) return;

  const t=ahora();
  registros.push({
    fecha:t.fecha,
    hora:t.hora,
    nombre:nombre.value,
    cargo:cargo.value,
    equipo:equipo.value,
    entrega:`${t.fecha} ${t.hora}`,
    devolucion:"",
    comentario:comentario.value
  });

  guardar();
  render();
  e.target.reset();
};

/* ================== DEVOLUCIÓN ================== */
function devolver(i){
  if(!confirm("¿Confirma devolución?")) return;
  const t=ahora();
  registros[i].devolucion = `${t.fecha} ${t.hora}`;
  guardar();
  render();
}

/* ================== PDF ================== */
function generarPDF(){
  const d=document.getElementById("desde").value;
  const h=document.getElementById("hasta").value;
  const datos = registros.filter(r=>r.fecha>=d && r.fecha<=h);

  if(!datos.length){ alert("No hay registros para ese rango"); return; }

  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF("l","mm","a4");

  let y=10;
  pdf.text(`Historial de Materiales (${d} a ${h})`,10,y);
  y+=8;

  datos.forEach(r=>{
    pdf.text(`${r.fecha} ${r.hora} | ${r.nombre} | ${r.cargo} | ${r.equipo} | Entrega:${r.entrega} | Devolución:${r.devolucion||"Pendiente"}`,10,y);
    y+=6;
    if(y>190){ pdf.addPage(); y=10; }
  });

  pdf.save("historial_materiales.pdf");
}

/* ================== RESPALDO ================== */
function exportar(){
  const blob=new Blob([JSON.stringify(registros,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="respaldo_materiales.json";
  a.click();
}

function importar(e){
  const f=e.target.files[0];
  if(!f) return;
  if(!confirm("Esto reemplazará los datos actuales")) return;
  const r=new FileReader();
  r.onload=()=>{ registros=JSON.parse(r.result); guardar(); render(); };
  r.readAsText(f);
}

render();
</script>
</body>
</html>
